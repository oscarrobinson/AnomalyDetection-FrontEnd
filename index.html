<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" / >
	<title>Temp Visualisation</title>
	<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script src="http://code.highcharts.com/highcharts.js"></script>
</head>
<body>
<div id="hour-graph"></div>
</body>
<script>

function drawGraph(allData, sensorData, graphId){
	allData = JSON.parse(allData);
	sensorData = JSON.parse(sensorData);

	var timeSeries = []

	for(var x=0; x<sensorData.sensors.length; x++){
		var dataList = [];
		var sensor = sensorData.sensors[x]
		for(var z=0; z<allData.readings.length; z++){
			var reading = allData.readings[z];
			dataList.push([parseInt(reading.time)*1000, reading[sensor["id"].toString()]]);
		}
		timeSeries.push({
	        name: sensor["name"],
	        data: dataList,
	        yAxis:0,
	        tooltip: {
                valueSuffix: ' Â°C'
            },
            zIndex: 1
        });


	}

	var anomalyScores = []
	var anomalyScores2 = []

	for(var z=0; z<allData.readings.length; z++){
		var reading = allData.readings[z];
		anomalyScores.push([parseInt(reading.time)*1000, reading.anomalyScore]);
		anomalyScores2.push([parseInt(reading.time)*1000, reading.anomalyScore2])
	}
	timeSeries.push({
	    name: "Anomaly Score",
	    data: anomalyScores,
	    yAxis:1,
	    tooltip: {
	        valueSuffix: ''
	    },
	    type: 'column',
	    zIndex: 0
     });

	timeSeries.push({
	    name: "Anomaly Score 2",
	    data: anomalyScores2,
	    yAxis:1,
	    tooltip: {
	        valueSuffix: ''
	    },
	    type: 'column',
	    zIndex: 0
     });


	$(function () {
	    $(graphId).highcharts({
	        chart: {
	            type: 'line'
	        },
	        title: {
	            text: 'Temperature Data'
	        },
	        subtitle: {
	            text: ''
	        },
	        xAxis: {
	            type: 'datetime',

	            title: {
	                text: 'Time'
	            }
	        },
	        yAxis: [{
	            title: {
	                text: 'Temperature/C'
	            },
	            min: 0,
	            tickInterval: 5,
	            minorTickInterval: 1
	        },
	        {
	        	title: {
	        		text: 'Anomaly Score'
	        	},
	        	min: 0,
	        	opposite: true
	        	//tickInterval: 100
	        }],
	        tooltip: {
	            shared: true
	        },

	        plotOptions: {
	        	line: {
	        		marker: {
	        			enabled: false
	        		}
	        	}
	        },

	        series: timeSeries
	    });
	});
}


$.get("http://178.62.40.4/api/readings-unixtime", {start: (Math.floor(Date.now() / 1000)-(60*60*2)).toString()})
	.done(function(data){
		//console.log(data);
		var tempData = data;
		$.get("http://178.62.40.4/api/sensors").
			done(function(data){
				drawGraph(tempData, data, "#hour-graph");
			});
	});

</script>
</html>