<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" / >
	<title>Temp Visualisation</title>
	<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script src="http://code.highcharts.com/highcharts.js"></script>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<script src="js/bootstrap.min.js"></script>
	<style>
		.modal-content{
			padding:10px;
		}
		.modal-content td{
			padding-right: 5px;
		}
		.modal-content input{
			padding-left: 10px;
		}
	</style>
</head>
<body>
<div id="feedback-modal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
     	<h2>Give Feedback</h2>
     		<table>
     			<tr>
     				<td><h4>Current Classification: </h4></td>
     				<td><h4><div id="modal-classification"></div></h4></td>
     			</tr>
     			<tr>
     				<td><h4>Desired Classification: </h4></td>
     				<td>
	     				<h4><div id="modal-feedback"></div></h4>
	     				<form action="" class="form-inline" id="feedback-selection">
							<input type="radio" name="feedback-radio" value="green">Green
							<input type="radio" name="feedback-radio" value="amber">Amber
							<input type="radio" name="feedback-radio" value="red">Red
						</form>
     				</td>
     			</tr>
     			<tr>
     				<td><h4>Anomaly Score: </h4></td>
     				<td><div id="modal-anomalyscore"></div></td>
     			</tr>
    		</table>
    </div>
  </div>
</div>
<div id="hour-graph"></div>
</body>
<script>

var NETWORK_NAME = "ucl-cs-machineroom";

function getClassificationLabel(color){
	if(color=="green"){
		return "<span class='label label-success'>Green</span>"
	}
	else if(color=="orange" || color=="amber"){
		return "<span class='label label-warning'>Amber</span>"
	}
	else if (color=="red"){
		return "<span class='label label-danger'>Red</span>"
	}
	else{
		return "<span class='label label-default'>None</span>"
	}
}


function drawGraph(allData, sensorData, thresholds, graphId){
	allData = JSON.parse(allData);
	sensorData = JSON.parse(sensorData);
	thresholds = JSON.parse(thresholds);

	var timeSeries = []

	for(var x=0; x<sensorData.sensors.length; x++){
		var dataList = [];
		var sensor = sensorData.sensors[x]
		for(var z=0; z<allData.readings.length; z++){
			var reading = allData.readings[z];
			dataList.push([parseInt(reading.time)*1000, reading[sensor["id"].toString()]]);
		}
		timeSeries.push({
	        name: sensor["name"],
	        data: dataList,
	        yAxis:0,
	        tooltip: {
                valueSuffix: ' Â°C'
            },
            zIndex: 1
        });


	}

	var anomalyScores = []

	var getColor = function(score, thresholds){
			if (score > thresholds.red){
				return "red";
			}
			else if(score > thresholds.amber){
				return "orange";
			}
			else{
				return "green";
			}
		}

	for(var z=0; z<allData.readings.length; z++){
		var reading = allData.readings[z];
		anomalyScores.push({x: parseInt(reading.time)*1000, y: reading.anomalyScore, color: getColor(reading.anomalyScore, thresholds)});
	}
	timeSeries.push({
	    name: "Anomaly Score",
	    data: anomalyScores,
	    yAxis:1,
	    tooltip: {
	        valueSuffix: ''
	    },
	    type: 'column',
	    zIndex: 0,
	    turboThreshold: 0
     });

	$(function () {
	    $(graphId).highcharts({
	        chart: {
	            type: 'line'
	        },
	        title: {
	            text: 'Temperature Data'
	        },
	        subtitle: {
	            text: ''
	        },
	        xAxis: {
	            type: 'datetime',

	            title: {
	                text: 'Time'
	            }
	        },
	        yAxis: [{
	            title: {
	                text: 'Temperature/C'
	            },
	            min: 0,
	            tickInterval: 5,
	            minorTickInterval: 1
	        },
	        {
	        	title: {
	        		text: 'Anomaly Score'
	        	},
	        	min: 0,
	        	max: 1,
	        	opposite: true
	        	//tickInterval: 100
	        }],
	        tooltip: {
	            shared: true
	        },

	        plotOptions: {
	        	line: {
	        		marker: {
	        			enabled: false
	        		}
	        	},
	        	series:{
	        		point: {
	        			events: {
	        				click: function (e) {
	        					var reading = this;
	        					$('#modal-classification').html(function(){
	        						return getClassificationLabel(reading.color)
	        					});

	        					$.get("http://178.62.40.4/api/readings/getone?time="+(reading.x/1000))
										.done(function(data){
											var readingDB = JSON.parse(data);
											$('#modal-feedback').html(getClassificationLabel(readingDB.feedback));
										});
	        					$('#modal-anomalyscore').html(reading.y);
	        					$('#feedback-modal').modal('show');
	        					$( "#feedback-selection" ).change(function() {
								  var feedback_val = $("input[name='feedback-radio']:checked").val();
								  $('#modal-feedback').html(getClassificationLabel(feedback_val));
								  var timeUnix = (reading.x/1000).toString();
								  console.log(feedback_val);
								  var postdata = { time: timeUnix, feedback: feedback_val};
								  $.post( "http://178.62.40.4/api/feedback", JSON.stringify(postdata) );
								});
	        				}
	        			}
	        		}
	        	}
	        },

	        series: timeSeries
	    });
	});
}


$.get("http://178.62.40.4/api/readings-unixtime", {start: (Math.floor(Date.now() / 1000)-(60*60*4)).toString()})
	.done(function(data){
		//console.log(data);
		var tempData = data;
		$.get("http://178.62.40.4/api/sensors").
			done(function(data){
				var sensors = data;
				$.get("http://178.62.40.4/api/thresholds/get?network="+NETWORK_NAME).
					done(function(data){
						var thresholds = data;
						drawGraph(tempData, sensors, thresholds, "#hour-graph");
					});
			});
	});

</script>
</html>